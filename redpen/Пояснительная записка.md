# Пояснительная записка к плагину "Красная Паста"

## 1. Общее описание

**Красная Паста** — это расширение для браузера Google Chrome, предназначенное для имитации работы редактора или учителя на веб-страницах. Плагин позволяет выделять текстовые фрагменты, зачеркивать их красным цветом и добавлять комментарии, которые отображаются при наведении курсора. Все правки сохраняются в локальном хранилище браузера и автоматически восстанавливаются после перезагрузки страницы.

**Основное назначение:**
- Визуальная маркировка ошибок в тексте.
- Добавление поясняющих комментариев для совместной работы или самообучения.
- Сохранение истории правок для последующего анализа.

**Целевая аудитория:**
- Редакторы, корректоры, преподаватели.
- Студенты, изучающие языки или работающие с текстами.
- Любые пользователи, которым требуется отмечать фрагменты на веб-страницах.

## 2. Функциональные возможности

### 2.1. Основные функции
- **Контекстное меню:** Пункт "Красная паста" появляется в контекстном меню браузера при выделении текста.
- **Визуальное оформление:** Выделенный текст зачеркивается красной линией, цвет текста меняется на красный.
- **Комментирование:** При выборе действия открывается диалоговое окно для ввода комментария.
- **Подсказки:** Комментарий отображается во всплывающей подсказке (title) при наведении на помеченный текст.
- **Сохранение данных:** Все правки сохраняются в `chrome.storage.local` с привязкой к URL страницы.
- **Восстановление:** При повторной загрузке страницы ранее сделанные правки автоматически восстанавливаются.

### 2.2. Дополнительные возможности
- **Поддержка SPA:** Расширение отслеживает изменения URL и DOM для корректной работы на одностраничных приложениях (например, ВКонтакте).
- **Уникальная идентификация:** Каждой правке присваивается уникальный ID, что предотвращает дублирование.
- **Обработка динамического контента:** Используется MutationObserver для отслеживания изменений DOM и восстановления правок.

## 3. Архитектура

### 3.1. Контекстная диаграмма (C4 Level 1)
![Контекстная диаграмма](c4_Level_1_context_diagram_RedPaste_v1.plantuml)

**Участники:**
- **Пользователь** — инициатор действий, выделяет текст и использует контекстное меню.
- **Красная Паста** — расширение Chrome, обрабатывающее запросы.
- **Браузер Chrome** — платформа, предоставляющая API расширений и рендеринг страниц.
- **Local Storage браузера** — встроенное хранилище для сохранения данных.

**Взаимодействия:**
1. Пользователь выделяет текст и выбирает пункт "Красная паста" в контекстном меню.
2. Расширение получает команду через Chrome Extensions API.
3. Расширение сохраняет правку в Local Storage.
4. При загрузке страницы расширение восстанавливает правки из хранилища.

### 3.2. Диаграмма контейнеров (C4 Level 2)
![Диаграмма контейнеров](c4_Level_2_containers_diagram_RedPaste_v1.plantuml)

**Компоненты расширения:**
1. **Service Worker (background.js)** — фоновый скрипт, отвечающий за:
   - Создание пункта контекстного меню при установке.
   - Обработку кликов по меню и передачу сообщений в content script.
2. **Content Script (content.js)** — скрипт, внедряемый на веб-страницу:
   - Обработка выделенного текста.
   - Применение CSS-стилей (зачеркивание, цвет).
   - Взаимодействие с хранилищем для сохранения/загрузки правок.
   - Восстановление правок при загрузке страницы и изменениях DOM.
3. **Local Storage (chrome.storage)** — база данных расширения:
   - Хранение массива правок с полями: id, text, comment, url, timestamp.

**Взаимодействие компонентов:**
- Service Worker регистрирует контекстное меню.
- При выборе пункта меню Service Worker отправляет сообщение в Content Script.
- Content Script обрабатывает выделение, применяет стили и сохраняет правку.
- При загрузке страницы Content Script запрашивает правки из хранилища и восстанавливает их.

## 4. Техническая реализация

### 4.1. Манифест (manifest.json)
- **Manifest V3** — современный стандарт расширений Chrome.
- **Права доступа:**
  - `contextMenus` — для создания контекстного меню.
  - `activeTab` — для работы с активной вкладкой.
  - `storage` — для использования локального хранилища.
- **Структура:**
  - `background.service_worker` — указание на background.js.
  - `content_scripts` — внедрение content.js на все страницы.

### 4.2. Ключевые модули

#### 4.2.1. background.js
- **Инициализация:** Создание пункта контекстного меню при установке расширения.
- **Обработка кликов:** Прослушивание события `chrome.contextMenus.onClicked` и отправка сообщения в активную вкладку.

#### 4.2.2. content.js
- **Инициализация:** Запускается при загрузке страницы (`DOMContentLoaded` и `load`).
- **Обработка выделения:** Функция `processSelection()`:
  - Получает выделенный текст через `window.getSelection()`.
  - Запрашивает комментарий через `prompt()`.
  - Создает элемент `<span>` с уникальным ID и стилями.
  - Сохраняет правку через `saveCorrection()`.
- **Восстановление правок:** Функция `restoreCorrections()`:
  - Загружает массив правок из хранилища.
  - Фильтрует правки по текущему URL.
  - Для каждой правки ищет соответствующий текст на странице с помощью `TreeWalker`.
  - Применяет стили и добавляет tooltip.
- **Отслеживание динамических изменений:**
  - Перехват `history.pushState` и `history.replaceState` для SPA.
  - Использование `MutationObserver` для отслеживания изменений DOM.

### 4.3. Алгоритмы и структуры данных

#### 4.3.1. Генерация ID
```javascript
function generateId() {
  return 'redpen_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}
```
ID состоит из префикса, временной метки и случайной строки, что гарантирует уникальность.

#### 4.3.2. Сохранение правки
Объект правки:
```javascript
{
  id: string,
  text: string,      // выделенный текст
  comment: string,   // комментарий пользователя
  url: string,       // URL страницы
  timestamp: number  // время создания
}
```
Данные сохраняются в `chrome.storage.local` под ключом `redPenCorrections` как массив объектов.

#### 4.3.3. Поиск текста на странице
Используется `TreeWalker` для обхода текстовых узлов. Алгоритм:
1. Игнорировать пустые узлы и узлы внутри `<script>`, `<style>`.
2. Найти индекс искомого текста в содержимом узла.
3. Проверить, не был ли текст уже обработан (по data-redpen-id).
4. Разделить узел на три части: до текста, текст (в `<span>`), после текста.
5. Заменить оригинальный узел на новые узлы.

### 4.4. Обработка ошибок
- **Некорректное выделение:** Если выделение охватывает несколько блоков, возникает ошибка при вызове `range.surroundContents()`. В этом случае выводится предупреждение пользователю.
- **Потеря правок:** При очистке хранилища браузера все правки удаляются. Резервное копирование не предусмотрено.

## 5. Хранение данных

### 5.1. Локальное хранилище
- **Технология:** `chrome.storage.local` (асинхронное API).
- **Объем:** До 10 МБ (ограничение Chrome).
- **Структура данных:**
  ```javascript
  {
    "redPenCorrections": [
      { /* правка 1 */ },
      { /* правка 2 */ }
    ]
  }
  ```
- **Жизненный цикл:** Данные сохраняются до явного удаления пользователем или расширением.

### 5.2. Привязка к URL
Каждая правка сохраняется с URL страницы, что позволяет восстанавливать правки только для соответствующих страниц. При изменении URL (например, переход на другую статью) правки не отображаются.

## 6. Взаимодействие с браузером

### 6.1. Chrome Extensions API
- **contextMenus:** Создание и управление контекстным меню.
- **tabs:** Отправка сообщений в активную вкладку.
- **storage:** Сохранение и загрузка данных.
- **runtime:** Обработка сообщений между компонентами.

### 6.2. DOM Manipulation
Content Script напрямую модифицирует DOM страницы:
- Добавление элементов `<span>` с inline-стилями.
- Изменение текстовых узлов.
- Установка атрибутов (`data-redpen-id`, `title`).

### 6.3. Обработка событий
- **События страницы:** `DOMContentLoaded`, `load`, `popstate`.
- **События расширения:** `chrome.runtime.onMessage`, `chrome.contextMenus.onClicked`.

## 7. Ограничения и известные проблемы

### 7.1. Ограничения
1. **Только текст:** Не поддерживается выделение изображений или других нетекстовых элементов.
2. **Однородное выделение:** Выделение должно находиться в пределах одного блока (не может пересекать границы элементов).
3. **Стилизация:** Используются inline-стили, которые могут конфликтовать с CSS страницы.
4. **Производительность:** При большом количестве правок (сотни) восстановление может замедлять загрузку страницы.
5. **Безопасность:** Расширение не работает на страницах с ограниченными политиками (например, chrome://, about:).

### 7.2. Известные проблемы
1. **Динамический контент:** На некоторых SPA (например, React-приложениях) восстановление правок может происходить с задержкой или требовать дополнительных настроек.
2. **Кодировка:** Нестандартные кодировки текста могут приводить к некорректному поиску.
3. **Конфликты:** Если другие расширения также модифицируют DOM, возможны конфликты.

## 8. Рекомендации по развитию

### 8.1. Ближайшие улучшения
1. **Управление правками:** Добавить панель для просмотра, редактирования и удаления сохраненных правок.
2. **Экспорт данных:** Возможность экспорта правок в формате JSON или PDF.
3. **Синхронизация:** Использование `chrome.storage.sync` для синхронизации между устройствами.
4. **Настройки стилей:** Позволить пользователю выбирать цвет зачеркивания, стиль линии и т.д.

### 8.2. Долгосрочные планы
1. **Поддержка других браузеров:** Адаптация для Firefox, Edge (на основе WebExtensions).
2. **Облачное хранение:** Интеграция с облачными сервисами для резервного копирования и совместной работы.
3. **Расширенные функции:** Добавление категорий правок, фильтрации, статистики.

## 9. Заключение

Плагин "Красная Паста" представляет собой простое, но полезное расширение для браузера Chrome, решающее задачу визуальной маркировки текста. Благодаря использованию современных технологий (Manifest V3, Chrome Extensions API) и вниманию к деталям (поддержка SPA, уникальная идентификация) он обеспечивает стабильную работу в большинстве сценариев.

Расширение может быть доработано в соответствии с потребностями пользователей, а его открытый исходный код позволяет сообществу участвовать в развитии проекта.

---
*Документация составлена на основе анализа исходного кода версии 1.0. Последнее обновление: 15.12.2025.*